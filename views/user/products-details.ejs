<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wearify - <%= product.name %></title>
  <link rel="stylesheet" href="/css/product-details.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Reviews Section Styling */
    .reviews-section { margin-top: 50px; border-top: 1px solid #30363d; padding-top: 30px; }
    .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .avg-rating-box { display: flex; align-items: center; gap: 10px; }
    .avg-stars { color: #ffc107; font-size: 1.4rem; }
    .review-card { background: #161b22; border: 1px solid #30363d; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
    .review-user-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .user-name { font-weight: 600; color: #f0f6fc; }
    .review-date { font-size: 0.85rem; color: #8b949e; }
    .review-stars { color: #ffc107; margin-bottom: 8px; }
    .review-text { color: #c9d1d9; line-height: 1.5; font-size: 0.95rem; }
    .no-reviews { text-align: center; padding: 40px; color: #8b949e; background: #0d1117; border-radius: 12px; border: 1px dashed #30363d; }
    /* Offer & Price Styling */
    .price-container { margin: 15px 0; display: flex; align-items: baseline; gap: 12px; }
    .sale-price { color: #2ea043; font-weight: bold; font-size: 2.2rem; margin: 0; }
    .original-price { text-decoration: line-through; color: #8b949e; font-size: 1.2rem; }
    .discount-badge { background: #da3633; color: white; padding: 4px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; }
    
    /* Related Products Styling */
    .related-price-box { margin-top: 8px; font-size: 0.95rem; }
    .related-sale { color: #2ea043; font-weight: bold; }
    .related-old { text-decoration: line-through; color: #8b949e; margin-left: 6px; font-size: 0.85rem; }
    
    /* Image Zoom */
    #zoom-container { overflow: hidden; cursor: crosshair; position: relative; border-radius: 8px; }
    #mainProductImage { transition: transform 0.2s ease-out; width: 100%; display: block; }
  </style>
</head>

<body class="details-page">

<header class="shop-header">
  <div class="logo">Wearify</div>

  <div class="icons">
            <a href="/wishlist" class="icon" style="text-decoration: none;">‚ù§Ô∏è</a>
            <a href="/home/cart" class="icon" style="text-decoration: none;">üõí</a>
        </div>
</header>

<main class="container">

  <nav class="breadcrumb">
    <a href="/">Men</a> /
    <a href="/products?category=<%= product.category?.name || '' %>">
      <%= product.category?.name || 'Products' %>
    </a>
  </nav>

  <section class="product-main">
    <h1><%= product.name %></h1>

    <div class="image-gallery">
      <div class="main-image" id="zoom-container">
        <img id="mainProductImage" src="<%= product.images?.[0] %>" alt="<%= product.name %>">
      </div>

      <div class="thumbnail-list">
        <% (product.images || []).forEach((img, index) => { %>
          <img src="<%= img %>" class="thumbnail <%= index === 0 ? 'active' : '' %>" onclick="changeImage('<%= img %>', this)">
        <% }) %>
      </div>
    </div>

    <div class="product-summary">
      <p class="description"><%= product.description || '' %></p>
      
      <div class="price-container">
        <% if (product.salePrice < product.regularPrice) { %>
          <h2 class="sale-price">‚Çπ<%= product.salePrice %></h2>
          <span class="original-price">‚Çπ<%= product.regularPrice %></span>
          <span class="discount-badge"><%= product.offerPercentage %>% OFF</span>
        <% } else { %>
          <h2 class="price">‚Çπ<%= product.price %></h2>
        <% } %>
      </div>

      <div class="size-options">
        <% (product.variants || []).forEach(v => { %>
          <button type="button" class="size-btn <%= v.stock === 0 ? 'disabled' : '' %>" 
                  data-size="<%= v.size %>" data-stock="<%= v.stock %>" 
                  onclick="selectSize(this)" <%= v.stock === 0 ? 'disabled' : '' %>>
            <%= v.size %>
          </button>
        <% }) %>
      </div>

      <div class="purchase-actions">
        <div class="quantity-picker">
          <button id="minusBtn" onclick="updateQty(-1)">‚àí</button>
          <input type="number" id="qty" value="1" readonly>
          <button id="plusBtn" onclick="updateQty(1)">+</button>
        </div>

        <button id="buyNowBtn" class="btn-buy">Buy Now</button>
        <button class="btn-cart">Add to Cart</button>
        <button class="btn-wishlist">‚ù§Ô∏è Wishlist</button>
      </div>
    </div>
  </section>
<section class="reviews-section">
    <div class="review-header">
      <h3>Customer Reviews</h3>
      <% if (product.reviews && product.reviews.length > 0) { %>
        <div class="avg-rating-box">
          <span class="avg-stars">‚òÖ <%= product.averageRating || 0 %></span>
          <span style="color: #8b949e;">(<%= product.reviews.length %> reviews)</span>
        </div>
      <% } %>
    </div>

    <div class="reviews-container">
      <% if (product.reviews && product.reviews.length > 0) { %>
        <% product.reviews.reverse().forEach(review => { %>
          <div class="review-card">
            <div class="review-user-row">
              <span class="user-name"><%= review.userName %></span>
              <span class="review-date"><%= new Date(review.createdAt).toLocaleDateString() %></span>
            </div>
            <div class="review-stars">
              <% for(let i=1; i<=5; i++) { %>
                <span style="color: <%= i <= review.rating ? '#ffc107' : '#30363d' %>">‚òÖ</span>
              <% } %>
            </div>
            <p class="review-text"><%= review.comment %></p>
          </div>
        <% }) %>
      <% } else { %>
        <div class="no-reviews">
          <p>No reviews yet. Be the first to share your thoughts!</p>
        </div>
      <% } %>
    </div>
  </section>
  <% if ((relatedProducts || []).length > 0) { %>
    <section class="related">
      <h3>Related Products</h3>
      <div class="related-grid">
        <% relatedProducts.forEach(item => { %>
          <div class="related-card">
            <a href="/shop/details/<%= item._id %>">
              <img src="<%= item.images?.[0] %>" alt="image">
            </a>
            <h4><%= item.name %></h4>
            <div class="related-price-box">
              <% if (item.salePrice < item.regularPrice) { %>
                <span class="related-sale">‚Çπ<%= item.salePrice %></span>
                <span class="related-old">‚Çπ<%= item.regularPrice %></span>
              <% } else { %>
                <span>‚Çπ<%= item.price %></span>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    </section>
  <% } %>
</main>

<script>
  let selectedStock = 0;

  function changeImage(src, el) {
    document.getElementById('mainProductImage').src = src;
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  function selectSize(btn) {
    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedStock = parseInt(btn.dataset.stock);
    document.getElementById('qty').value = 1;
    updateButtons();
  }

  function updateQty(change) {
    const input = document.getElementById('qty');
    let value = parseInt(input.value);
    value += change;
    if (value < 1) value = 1;
    if (value > selectedStock) value = selectedStock;
    input.value = value;
    updateButtons();
  }

  function updateButtons() {
    const qty = parseInt(document.getElementById('qty').value);
    document.getElementById('plusBtn').disabled = qty >= selectedStock;
    document.getElementById('minusBtn').disabled = qty <= 1;
  }

  // Zoom Logic
  const container = document.getElementById('zoom-container');
  const img = document.getElementById('mainProductImage');
  container.addEventListener('mousemove', (e) => {
    const rect = container.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / container.offsetWidth) * 100;
    const y = ((e.clientY - rect.top) / container.offsetHeight) * 100;
    img.style.transformOrigin = `${x}% ${y}%`;
    img.style.transform = "scale(2)";
  });
  container.addEventListener('mouseleave', () => {
    img.style.transform = "scale(1)";
  });

  // Add to Cart Logic
  document.querySelector('.btn-cart').addEventListener('click', async () => {
    const activeSizeBtn = document.querySelector('.size-btn.active');
    if (!activeSizeBtn) {
      return Swal.fire({ icon: 'warning', title: 'Select Size', text: 'Please choose a size.', background: '#161b22', color: '#fff' });
    }

    try {
      const response = await fetch(`/shop/details/<%= product._id %>`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          productId: "<%= product._id %>", 
          size: activeSizeBtn.dataset.size, 
          quantity: document.getElementById('qty').value 
        })
      });
      const data = await response.json();
      if (data.success) {
        Swal.fire({ icon: 'success', title: 'Added!', text: data.message, timer: 1500, showConfirmButton: false });
      } else {
        Swal.fire({ icon: 'error', title: 'Error', text: data.message });
      }
    } catch (err) {
      Swal.fire({ icon: 'error', title: 'Error', text: 'Server connection failed.' });
    }
  });

  // Buy Now Logic
  document.getElementById('buyNowBtn').addEventListener('click', async () => {
    const activeSizeBtn = document.querySelector('.size-btn.active');
    if (!activeSizeBtn) {
      return Swal.fire({ icon: 'warning', title: 'Select Size', text: 'Please choose a size first.' });
    }
    // Logic to add to cart and then redirect to checkout
    const response = await fetch(`/shop/details/<%= product._id %>`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        productId: "<%= product._id %>", 
        size: activeSizeBtn.dataset.size, 
        quantity: document.getElementById('qty').value 
      })
    });
    const data = await response.json();
    if (data.success) window.location.href = '/cart/checkout';
  });

  // Add to Wishlist Logic
document.querySelector('.btn-wishlist').addEventListener('click', async () => {
    const productId = "<%= product._id %>";

    try {
        // Updated URL to match your route: /shop/details/:product__id/wishlist
        const response = await fetch(`/shop/details/${productId}/wishlist`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId }) 
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Wishlist Updated',
                text: data.message,
                background: '#161b22',
                color: '#fff',
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Note',
                text: data.message,
                background: '#161b22',
                color: '#fff'
            });
        }
    } catch (err) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update wishlist.' });
    }
});
</script>

</body>
</html>