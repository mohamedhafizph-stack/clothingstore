<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wearify - My Wallet</title>
    <link rel="stylesheet" href="/css/userSignup.css"> <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .wallet-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
        }
        .balance-label { color: #8b949e; font-size: 14px; }
        .balance-amount { color: #fff; font-size: 48px; font-weight: bold; margin: 10px 0; }
        .btn-add {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
        }
        .btn-add:hover { background: #2ea043; }
    </style>
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="wallet-card">
            <h1 style="color: white;">My Wallet</h1>
            <p class="balance-label">Current Balance</p>
            <p class="balance-amount">₹<%= user.wallet.toFixed(2) %></p>
            
            <button class="btn-add" onclick="handleAddMoney()">+ Add Money</button>
            
            <div style="margin-top: 20px;">
                <a href="/profile" style="color: #58a6ff; text-decoration: none; font-size: 14px;">Back to Profile</a>
            </div>
        </div>
    </div>

    <script>
        // async function handleAddMoney() {
            const { value: amount } = await Swal.fire({
                title: 'Add Funds',
                input: 'number',
                inputLabel: 'Enter amount to add',
                inputPlaceholder: 'Enter amount in ₹',
                showCancelButton: true,
                background: '#161b22',
                color: '#fff',
                confirmButtonColor: '#238636',
                inputValidator: (value) => {
                    if (!value || value <= 0) {
                        return 'Please enter a valid amount!';
                    }
                }
            });

            if (amount) {
                const response = await fetch('/wallet/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                const data = await response.json();

                if (data.success) {
                    Swal.fire({ icon: 'success', title: 'Success', text: data.message, background: '#161b22', color: '#fff' })
                    .then(() => window.location.reload());
                } else {
                    Swal.fire({ icon: 'error', title: 'Failed', text: data.message, background: '#161b22', color: '#fff' });
                }
            }
        }
    </script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
async function handleAddMoney() {
    const { value: amount } = await Swal.fire({
        title: 'Add Money',
        input: 'number',
        inputLabel: 'Enter amount in ₹',
        background: '#161b22',
        color: '#fff',
        showCancelButton: true
    });

    if (amount && amount > 0) {
        // 1. Create Order on Server
        const orderResponse = await fetch('/wallet/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount })
        });
        const orderData = await orderResponse.json();

        if (orderData.success) {
            const options = {
                "key": "<%= process.env.RAZORPAY_KEY_ID %>", // Enter your Key ID here
                "amount": orderData.order.amount,
                "currency": "INR",
                "name": "Wearify",
                "description": "Wallet Top-up",
                "order_id": orderData.order.id,
                "handler": async function (response) {
                    // 2. Verify Payment on Server
                    const verifyRes = await fetch('/wallet/verify-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ response, amount })
                    });
                    const verifyData = await verifyRes.json();

                    if (verifyData.success) {
                        Swal.fire('Success', '₹' + amount + ' added!', 'success')
                        .then(() => window.location.reload());
                    }
                },
                "theme": { "color": "#6366f1" }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        }
    }
}
</script>
</body>
</html>