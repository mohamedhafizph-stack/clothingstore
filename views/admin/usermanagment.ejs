<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wearify Admin | User Management</title>
    <link rel="stylesheet" href="/css/usermanagment.css">
    <link rel="stylesheet" href="/css/adminDashboard.css">
    <%- include('../partials/sidebar', { activePage: 'users' }) %>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>


    <div class="main-content">
        <header class="header">
            <div class="header-titles">
                <h1>User Management</h1>
                <p style="color: var(--text-secondary); margin: 0;">Manage your customers and staff</p>
            </div>
            
            <div class="header-profile">
                <span class="header-label">Admin Panel</span>
                <div class="profile-icon-container">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=6366f1&color=fff" alt="Profile">
                </div>
            </div>
        </header>

        <div class="user-controls">
           <form action="/admin/users" method="GET" class="search-wrapper">
  <input
    type="text"
    name="search"
    class="search-input"
    placeholder="Search users by name or email..."
    value="<%= search || '' %>"
  >

  <% if (search) { %>
    <a href="/admin/users" class="cancel-btn">âœ–</a>
  <% } %>
</form>

        </div>

        <div class="user-table-card">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                       
                        <th>Status</th>
                        <th>Joined Date</th>
                        <th>Actions</th>
                        <th>Total orders</th>
                    </tr>
                </thead>
                <tbody>
                    <% users.forEach(user => { %>
                    <tr>
                 <td>
  <div class="user-info-cell">
    <% if (user.profilePic) { %>
      <img src="<%= user.profilePic %>" class="user-avatar" alt="User">
    <% } else { %>
      <img 
        src="https://ui-avatars.com/api/?name=<%= encodeURIComponent(user.name) %>&background=1c2e2a&color=fff"
        class="user-avatar"
        alt="Avatar"
      >
    <% } %>
    <span><%= user.name %></span>
  </div>
</td>

                        <td><%= user.email %></td>
                        <td>
                            <span class="status-badge <%= user.status === 'Active' ? 'status-active' : 'status-inactive' %>">
                                <%= user.status %>
                            </span>
                        </td>
                        <td><%= user.createdAt.toLocaleString() %></td>
                       <td id="status-container-<%= user._id %>">
  <button 
    class="action-btn toggle-status-btn <%= user.status === 'active' ? 'block-btn' : 'unblock-btn' %>" 
    data-id="<%= user._id %>"
    data-current-status="<%= user.status %>">
    <%= user.status === 'active' ? 'Block' : 'Unblock' %>
  </button>
</td>
<td><%= user.orderCount %></td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
    <%- include('../partials/pagination', { currentPage, totalPages }) %>

        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.querySelectorAll('.toggle-status-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-id');
        const currentStatus = this.getAttribute('data-current-status');
        const action = currentStatus === 'active' ? 'block' : 'unblock';

        // Confirmation dialog
        const result = await Swal.fire({
            title: `Are you sure?`,
            text: `You want to ${action} this user!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: action === 'block' ? '#d33' : '#28a745',
            confirmButtonText: `Yes, ${action} them!`
        });

        if (result.isConfirmed) {
            try {
                // Fetch call to your existing routes
                const response = await fetch(`/admin/users/${action}/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    // Update UI without refreshing
                    const newStatus = action === 'block' ? 'inactive' : 'active';
                    
                    // 1. Update the Button
                    this.setAttribute('data-current-status', newStatus);
                    this.textContent = newStatus === 'active' ? 'Block' : 'Unblock';
                    this.className = `action-btn toggle-status-btn ${newStatus === 'active' ? 'block-btn' : 'unblock-btn'}`;

                    // 2. Update the Status Badge in the same row
                    const row = this.closest('tr');
                    const badge = row.querySelector('.status-badge');
                    badge.textContent = newStatus;
                    badge.className = `status-badge ${newStatus === 'active' ? 'status-active' : 'status-inactive'}`;

                    Swal.fire('Updated!', `User has been ${action}ed.`, 'success');
                }
            } catch (error) {
                Swal.fire('Error', 'Something went wrong', 'error');
            }
        }
    });
});
</script>
</html>